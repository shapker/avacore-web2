def get_user_stats_for_web(user_id):
    """Собирает статистику пользователя для веб-приложения"""
    connection = sqlite3.connect('messages.db')
    cursor = connection.cursor()
    
    # Общая статистика
    cursor.execute("""
        SELECT 
            COUNT(*) as total_messages,
            SUM(CASE WHEN is_med = 0 THEN 1 ELSE 0 END) as text_messages,
            SUM(CASE WHEN is_med = 1 THEN 1 ELSE 0 END) as media_messages,
            COUNT(DISTINCT sender_id) as unique_senders
        FROM messages 
        WHERE user_id = ?
    """, (str(user_id),))
    
    stats = cursor.fetchone()
    
    # Статистика по типам медиа
    cursor.execute("""
        SELECT 
            CASE 
                WHEN path LIKE '%.jpg%' OR path LIKE '%.jpeg%' OR path LIKE '%.png%' THEN 'photo'
                WHEN path LIKE '%.mp4%' OR path LIKE '%.avi%' OR path LIKE '%.mov%' THEN 'video'
                WHEN path LIKE '%.ogg%' AND path LIKE '%voice%' THEN 'voice'
                WHEN path LIKE '%.ogg%' OR path LIKE '%.mp3%' THEN 'audio'
                WHEN path LIKE '%.webp%' THEN 'sticker'
                ELSE 'document'
            END as media_type,
            COUNT(*) as count
        FROM messages 
        WHERE user_id = ? AND is_med = 1
        GROUP BY media_type
    """, (str(user_id),))
    
    media_stats = dict(cursor.fetchall())
    
    # Получаем реальные медиафайлы
    cursor.execute("""
        SELECT text, user_login, message_id, is_med, path, datetime(message_id, 'unixepoch') as message_date
        FROM messages 
        WHERE user_id = ? AND is_med = 1
        ORDER BY message_id DESC 
        LIMIT 50
    """, (str(user_id),))
    
    recent_messages = []
    for msg in cursor.fetchall():
        recent_messages.append({
            'text': msg[0] or '',
            'user_login': msg[1],
            'is_media': bool(msg[3]),
            'path': msg[4],
            'date': msg[5]
        })
    
    connection.close()
    
    return {
        'user_id': user_id,
        'total_messages': stats[0] if stats else 0,
        'text_messages': stats[1] if stats else 0,
        'media_messages': stats[2] if stats else 0,
        'unique_senders': stats[3] if stats else 0,
        'media_stats': media_stats,
        'recent_messages': recent_messages,
        'timestamp': datetime.now().isoformat()
    }
